generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Rol {
  SUPER_ADMIN
  ADMIN
  DOCTOR
  NURSE
  RECEPTIONIST
  PATIENT
  PHARMACIST
  LAB_TECHNICIAN
}

enum Genero {
  Masculino
  Femenino
  Otro
}

enum EstadoCita {
  PorAgendar    // Cuando doctor solicita procedimiento/examen sin fecha/hora
  Programada
  Confirmada
  EnEspera
  Atendiendo
  Completada
  Cancelada
  NoAsistio
}

enum Estado {
  Activo
  Inactivo
}

model Usuario {
  id                String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email             String          @unique @db.VarChar(255)
  password          String          @db.VarChar(255)
  nombre            String          @db.VarChar(255)
  apellido          String          @db.VarChar(255)
  rol               String          @db.VarChar(50)
  telefono          String?         @db.VarChar(20)
  cedula            String?         @db.VarChar(50)
  activo            Boolean         @default(true)
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @default(now()) @map("updated_at")
  
  // Relaciones
  doctor                        Doctor?
  citasComoDoctor               Cita[]                  @relation("CitasDoctor")
  departamentosResponsable      Departamento[]          @relation("DepartamentoResponsable")
  ordenesMedicasComoDoctor      OrdenMedica[]           @relation("OrdenMedicaDoctor")
  ordenesMedicasComoEjecutor    OrdenMedica[]           @relation("OrdenMedicaEjecutor")
  ordenesMedicamentosComoDoctor OrdenMedicamento[]      @relation("OrdenMedicamentoDoctor")
  ordenesMedicamentosComoDespachador OrdenMedicamento[] @relation("OrdenMedicamentoDespachador")
  facturasCreadas               Factura[]
  pagosRegistrados              Pago[]
  // HCE
  evolucionesClinicas           EvolucionClinica[]      @relation("EvolucionDoctor")
  signosVitalesRegistrados      SignoVital[]            @relation("SignoVitalRegistrador")
  diagnosticosHCE               DiagnosticoHCE[]        @relation("DiagnosticoHCEDoctor")
  alertasReconocidas            AlertaClinica[]         @relation("AlertaReconocedor")
  auditoriaHCE                  AuditoriaHCE[]          @relation("AuditoriaHCEUsuario")
  interconsultasSolicitadas     Interconsulta[]         @relation("InterconsultasSolicitadas")
  interconsultasRespondidas     Interconsulta[]         @relation("InterconsultasRespondidas")
  procedimientosResponsable     Procedimiento[]         @relation("ProcedimientoResponsable")
  procedimientosFirmados        Procedimiento[]         @relation("ProcedimientoFirma")
  prescripcionesMedico          Prescripcion[]          @relation("PrescripcionMedico")
  prescripcionesFirmadas        Prescripcion[]          @relation("PrescripcionFirma")
  administracionesMedicamentos  AdministracionMedicamento[] @relation("AdministracionEnfermera")
  urgenciasMedico               AtencionUrgencia[]      @relation("UrgenciaMedico")
  urgenciasEnfermera            AtencionUrgencia[]      @relation("UrgenciaEnfermera")
  asignacionesEnfermeria        AsignacionEnfermeria[]  @relation("EnfermeraAsignaciones")
  notasEnfermeria               NotaEnfermeria[]        @relation("NotasEnfermera")

  // Talento Humano
  tHEmpleado                    tHEmpleado?
  tHEntrevistasRealizadas       tHEntrevista[]
  tHVacacionesAprobadas         tHVacacion[]
  tHPermisosAprobados           tHPermiso[]
  tHReconocimientosOtorgados    tHReconocimiento[]
  tHConversacionesIA            tHConversacionIA[]
  tHPeriodosNominaProcesados    tHPeriodoNomina[]

  @@map("usuarios")
}

model Paciente {
  id                             String    @id @default(uuid())
  
  // Datos Personales
  nombre                         String
  apellido                       String
  tipoDocumento                  String?   @map("tipo_documento")
  cedula                         String    @unique
  fechaNacimiento                DateTime? @map("fecha_nacimiento") @db.Date
  genero                         String?
  estadoCivil                    String?   @map("estado_civil")
  
  // Ubicación y Residencia
  paisNacimiento                 String?   @map("pais_nacimiento")
  departamento                   String?
  municipio                      String?
  barrio                         String?
  direccion                      String?
  
  // Contacto
  telefono                       String?
  email                          String?
  
  // Contactos de Emergencia (JSON array)
  contactosEmergencia            Json?     @map("contactos_emergencia")
  
  // Aseguramiento en Salud
  eps                            String?
  regimen                        String?
  tipoAfiliacion                 String?   @map("tipo_afiliacion")
  nivelSisben                    String?   @map("nivel_sisben")
  numeroAutorizacion             String?   @map("numero_autorizacion")
  fechaAfiliacion                DateTime? @map("fecha_afiliacion") @db.Date
  convenio                       String?
  carnetPoliza                   String?   @map("carnet_poliza")
  arl                            String?
  
  // Información Demográfica y Laboral
  ocupacion                      String?
  nivelEducacion                 String?   @map("nivel_educacion")
  empleadorActual                String?   @map("empleador_actual")
  tipoUsuario                    String?   @map("tipo_usuario")
  
  // Información de Referencia
  referidoPor                    String?   @map("referido_por")
  nombreRefiere                  String?   @map("nombre_refiere")
  tipoPaciente                   String?   @map("tipo_paciente")
  categoria                      String?
  
  // Información Médica
  tipoSangre                     String?   @map("tipo_sangre")
  peso                           Float?
  altura                         Float?
  alergias                       String?
  enfermedadesCronicas           String?   @map("enfermedades_cronicas")
  medicamentosActuales           String?   @map("medicamentos_actuales")
  antecedentesQuirurgicos        String?   @map("antecedentes_quirurgicos")
  
  // Estado
  estado                         String    @default("Activo")
  ultimaConsulta                 DateTime? @map("ultima_consulta") @db.Date
  activo                         Boolean   @default(true)
  createdAt                      DateTime  @default(now()) @map("created_at")
  updatedAt                      DateTime  @updatedAt @map("updated_at")
  
  // Relaciones
  citas                          Cita[]
  documentos                     DocumentoPaciente[]
  admisiones                     Admision[]
  ordenesMedicas                 OrdenMedica[]
  ordenesMedicamentos            OrdenMedicamento[]
  facturas                       Factura[]
  // HCE
  evolucionesClinicas            EvolucionClinica[]
  signosVitales                  SignoVital[]
  diagnosticosHCE                DiagnosticoHCE[]
  alertasClinicas                AlertaClinica[]
  interconsultas                 Interconsulta[]
  procedimientos                 Procedimiento[]
  prescripciones                 Prescripcion[]
  administracionesMedicamentos   AdministracionMedicamento[]
  atencionesUrgencias            AtencionUrgencia[]
  notasEnfermeria                NotaEnfermeria[]

  @@map("pacientes")
}

model Cita {
  id                      String                @id @default(uuid())
  pacienteId              String                @map("paciente_id")
  doctorId                String?               @map("doctor_id") @db.Uuid // Opcional para citas PorAgendar
  admisionId              String?               @map("admision_id") // Opcional - vincula cita con admisión hospitalaria
  especialidadId          String?               @map("especialidad_id") @db.Uuid
  examenProcedimientoId   String?               @map("examen_procedimiento_id") @db.Uuid
  tipoCita                String?               @default("Especialidad") @map("tipo_cita") @db.VarChar(50) // 'Especialidad', 'Examen', 'Procedimiento', 'Interconsulta'
  fecha                   DateTime?             @db.Date // Opcional para citas PorAgendar
  hora                    DateTime?             @db.Time // Opcional para citas PorAgendar
  duracionMinutos         Int?                  @default(30) @map("duracion_minutos")
  costo                   Decimal               @default(0) @db.Decimal(10, 2) // Default 0 para PorAgendar
  motivo                  String
  estado                  EstadoCita            @default(PorAgendar) // Default cuando doctor solicita
  prioridad               String?               @default("Media") @db.VarChar(50) // Baja, Media, Alta, Urgente
  notas                   String?
  createdAt               DateTime              @default(now()) @map("created_at")
  updatedAt               DateTime              @updatedAt @map("updated_at")
  
  // Relaciones
  paciente                Paciente              @relation(fields: [pacienteId], references: [id], onDelete: Cascade)
  doctor                  Usuario?              @relation("CitasDoctor", fields: [doctorId], references: [id], onDelete: Cascade)
  admision                Admision?             @relation(fields: [admisionId], references: [id], onDelete: SetNull)
  especialidad            Especialidad?         @relation(fields: [especialidadId], references: [id])
  examenProcedimiento     ExamenProcedimiento?  @relation(fields: [examenProcedimientoId], references: [id])
  ordenesMedicas          OrdenMedica[]
  ordenesMedicamentos     OrdenMedicamento[]
  itemsFactura            FacturaItem[]
  evolucionesClinicas     EvolucionClinica[]
  signosVitales           SignoVital[]
  procedimientos          Procedimiento[]
  prescripciones          Prescripcion[]
  atencionesUrgencias     AtencionUrgencia[]

  @@map("citas")
}

model Departamento {
  id                  String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  nombre              String          @unique @db.VarChar(255)
  descripcion         String?
  responsableId       String?         @map("responsable_id") @db.Uuid
  estado              String          @default("Activo") @db.VarChar(20)
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @default(now()) @map("updated_at")
  
  // Relaciones
  responsable         Usuario?        @relation("DepartamentoResponsable", fields: [responsableId], references: [id])
  especialidades      Especialidad[]

  @@map("departamentos")
}

model Especialidad {
  id                    String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  titulo                String        @db.VarChar(255)
  codigo                String?       @db.VarChar(50)
  departamentoId        String        @map("departamento_id") @db.Uuid
  costoCOP              Decimal       @map("costo_cop") @db.Decimal(10, 2)
  duracionMinutos       Int           @map("duracion_minutos")
  duracionExternaMin    Int?          @map("duracion_externa_min")
  duracionInternaMin    Int?          @map("duracion_interna_min")
  descripcion           String?
  estado                String        @default("Activo") @db.VarChar(20)
  createdAt             DateTime      @default(now()) @map("created_at")
  updatedAt             DateTime      @default(now()) @map("updated_at")
  
  // Relaciones
  departamento          Departamento  @relation(fields: [departamentoId], references: [id], onDelete: Cascade)
  doctores              DoctorEspecialidad[]
  citas                 Cita[]

  @@map("especialidades")
}
model Doctor {
  id                 String   @id @default(uuid()) @db.Uuid
  usuarioId          String   @unique @map("usuario_id") @db.Uuid
  licenciaMedica     String   @map("licencia_medica")
  universidad        String?
  aniosExperiencia   Int?     @map("anios_experiencia")
  biografia          String?  @db.Text
  horarios           Json?
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  usuario            Usuario  @relation(fields: [usuarioId], references: [id])
  especialidades     DoctorEspecialidad[]

  @@map("doctores")
}

model DoctorEspecialidad {
  id              String   @id @default(uuid()) @db.Uuid
  doctorId        String   @map("doctor_id") @db.Uuid
  especialidadId  String   @map("especialidad_id") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at")

  doctor          Doctor       @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  especialidad    Especialidad @relation(fields: [especialidadId], references: [id])

  @@unique([doctorId, especialidadId])
  @@map("doctores_especialidades")
}

model CategoriaExamen {
  id              String              @id @default(uuid()) @db.Uuid
  nombre          String              @db.VarChar(255)
  descripcion     String              @db.Text
  colorHex        String              @map("color_hex") @db.VarChar(7)
  estado          String              @default("Activo") @db.VarChar(50)
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  examenes        ExamenProcedimiento[]

  @@map("categorias_examenes")
}

model ExamenProcedimiento {
  id                  String            @id @default(uuid()) @db.Uuid
  tipo                String            @db.VarChar(50) // 'Examen' o 'Procedimiento'
  nombre              String            @db.VarChar(255)
  descripcion         String?           @db.Text
  categoriaId         String?           @map("categoria_id") @db.Uuid
  duracionMinutos     Int               @map("duracion_minutos")
  costoBase           Decimal           @map("costo_base") @db.Decimal(10, 2)
  preparacionEspecial String?           @map("preparacion_especial") @db.Text
  requiereAyuno       Boolean           @default(false) @map("requiere_ayuno")
  estado              String            @default("Activo") @db.VarChar(50)
  createdAt           DateTime          @default(now()) @map("created_at")
  updatedAt           DateTime          @updatedAt @map("updated_at")

  categoria           CategoriaExamen?  @relation(fields: [categoriaId], references: [id], onDelete: SetNull)
  ordenesMedicas      OrdenMedica[]
  citas               Cita[]

  @@map("examenes_procedimientos")
}

// Modelos de Farmacia
model CategoriaProducto {
  id          String     @id @default(uuid())
  nombre      String
  descripcion String?
  color       String?
  activo      Boolean    @default(true)
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  
  productos   Producto[]

  @@map("categorias_productos")
}

model EtiquetaProducto {
  id          String     @id @default(uuid())
  nombre      String
  color       String?
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  
  productos   ProductoEtiqueta[]

  @@map("etiquetas_productos")
}

model Producto {
  id                          String    @id @default(uuid())
  
  // Información Básica
  nombre                      String
  categoriaId                 String    @map("categoria_id")
  sku                         String    @unique
  laboratorio                 String?
  descripcion                 String?
  
  // Información Farmacológica
  principioActivo             String?   @map("principio_activo")
  concentracion               String?
  viaAdministracion           String?   @map("via_administracion")
  presentacion                String?
  registroSanitario           String?   @map("registro_sanitario")
  temperaturaAlmacenamiento   String?   @map("temperatura_almacenamiento")
  requiereReceta              Boolean   @default(false) @map("requiere_receta")
  
  // Inventario
  cantidadTotal               Int       @map("cantidad_total")
  cantidadConsumida           Int       @default(0) @map("cantidad_consumida")
  cantidadMinAlerta           Int       @map("cantidad_min_alerta")
  lote                        String?
  fechaVencimiento            DateTime? @map("fecha_vencimiento")
  
  // Precios
  precioVenta                 Float     @map("precio_venta")
  precioCompra                Float?    @map("precio_compra")
  
  // Estado e Imagen
  activo                      Boolean   @default(true)
  imagenUrl                   String?   @map("imagen_url")
  
  createdAt                   DateTime  @default(now()) @map("created_at")
  updatedAt                   DateTime  @updatedAt @map("updated_at")
  
  // Relaciones
  categoria                   CategoriaProducto @relation(fields: [categoriaId], references: [id])
  etiquetas                   ProductoEtiqueta[]
  ordenesItems                OrdenMedicamentoItem[]
  prescripcionesMedicamentos  PrescripcionMedicamento[] @relation("PrescripcionProducto")

  @@map("productos")
}

model ProductoEtiqueta {
  id          String            @id @default(uuid())
  productoId  String            @map("producto_id")
  etiquetaId  String            @map("etiqueta_id")
  createdAt   DateTime          @default(now()) @map("created_at")
  
  producto    Producto          @relation(fields: [productoId], references: [id], onDelete: Cascade)
  etiqueta    EtiquetaProducto  @relation(fields: [etiquetaId], references: [id], onDelete: Cascade)

  @@unique([productoId, etiquetaId])
  @@map("productos_etiquetas")
}

model DocumentoPaciente {
  id              String    @id @default(uuid())
  pacienteId      String    @map("paciente_id")
  nombreArchivo   String    @map("nombre_archivo")
  nombreOriginal  String    @map("nombre_original")
  tipoArchivo     String    @map("tipo_archivo")
  tamano          Int       // en bytes
  rutaArchivo     String    @map("ruta_archivo")
  descripcion     String?
  categoria       String?   // Ej: "Historia Clínica", "Resultados", "Consentimiento", etc.
  uploadedBy      String?   @map("uploaded_by") @db.Uuid
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  paciente        Paciente  @relation(fields: [pacienteId], references: [id], onDelete: Cascade)

  @@map("documentos_paciente")

}

// ===================================
// MÓDULO DE HOSPITALIZACIÓN
// ===================================

model Unidad {
  id              String        @id @default(uuid())
  nombre          String        @unique
  descripcion     String?
  tipo            String        // UCI, Observación, Hospitalización General, Pediatría, etc.
  capacidad       Int           @default(0)
  activo          Boolean       @default(true)
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relaciones
  habitaciones           Habitacion[]
  admisiones             Admision[]
  movimientosOrigen      Movimiento[]  @relation("MovimientoUnidadOrigen")
  movimientosDestino     Movimiento[]  @relation("MovimientoUnidadDestino")
  asignacionesEnfermeria AsignacionEnfermeria[]

  @@map("unidades")
}

model Habitacion {
  id              String        @id @default(uuid())
  numero          String
  unidadId        String        @map("unidad_id")
  piso            Int?
  capacidadCamas  Int           @default(1) @map("capacidad_camas")
  activo          Boolean       @default(true)
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relaciones
  unidad          Unidad        @relation(fields: [unidadId], references: [id], onDelete: Cascade)
  camas           Cama[]

  @@unique([numero, unidadId])
  @@map("habitaciones")
}

model Cama {
  id              String        @id @default(uuid())
  numero          String
  habitacionId    String        @map("habitacion_id")
  estado          EstadoCama    @default(Disponible)
  observaciones   String?
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relaciones
  habitacion           Habitacion    @relation(fields: [habitacionId], references: [id], onDelete: Cascade)
  admisiones           Admision[]
  movimientosOrigen    Movimiento[]  @relation("MovimientoCamaOrigen")
  movimientosDestino   Movimiento[]  @relation("MovimientoCamaDestino")

  @@unique([numero, habitacionId])
  @@map("camas")
}

model Admision {
  id                    String            @id @default(uuid())
  pacienteId            String            @map("paciente_id")
  unidadId              String            @map("unidad_id")
  camaId                String?           @map("cama_id")
  fechaIngreso          DateTime          @map("fecha_ingreso") @default(now())
  fechaEgreso           DateTime?         @map("fecha_egreso")
  motivoIngreso         String            @map("motivo_ingreso")
  diagnosticoIngreso    String            @map("diagnostico_ingreso")
  diagnosticoEgreso     String?           @map("diagnostico_egreso")
  estado                EstadoAdmision    @default(Activa)
  observaciones         String?
  responsableIngreso    String?           @map("responsable_ingreso") @db.Uuid
  responsableEgreso     String?           @map("responsable_egreso") @db.Uuid
  createdAt             DateTime          @default(now()) @map("created_at")
  updatedAt             DateTime          @updatedAt @map("updated_at")

  // Relaciones
  paciente              Paciente          @relation(fields: [pacienteId], references: [id], onDelete: Cascade)
  unidad                Unidad            @relation(fields: [unidadId], references: [id])
  cama                  Cama?             @relation(fields: [camaId], references: [id])
  citas                 Cita[]            // Citas vinculadas a la admisión (procedimientos, interconsultas)
  movimientos           Movimiento[]
  ordenesMedicas        OrdenMedica[]
  ordenesMedicamentos   OrdenMedicamento[]
  itemsFactura          FacturaItem[]
  evolucionesClinicas   EvolucionClinica[]
  signosVitales         SignoVital[]
  diagnosticosHCE       DiagnosticoHCE[]
  egreso                Egreso?
  interconsultas        Interconsulta[]
  procedimientos        Procedimiento[]
  prescripciones        Prescripcion[]
  atencionesUrgencias   AtencionUrgencia[]
  notasEnfermeria       NotaEnfermeria[]

  @@map("admisiones")
}

model Movimiento {
  id                    String            @id @default(uuid())
  admisionId            String            @map("admision_id")
  tipo                  TipoMovimiento
  unidadOrigenId        String?           @map("unidad_origen_id")
  unidadDestinoId       String?           @map("unidad_destino_id")
  camaOrigenId          String?           @map("cama_origen_id")
  camaDestinoId         String?           @map("cama_destino_id")
  motivo                String
  observaciones         String?
  responsable           String?           @db.Uuid
  fechaMovimiento       DateTime          @default(now()) @map("fecha_movimiento")
  createdAt             DateTime          @default(now()) @map("created_at")

  // Relaciones
  admision              Admision          @relation(fields: [admisionId], references: [id], onDelete: Cascade)
  unidadOrigen          Unidad?           @relation("MovimientoUnidadOrigen", fields: [unidadOrigenId], references: [id])
  unidadDestino         Unidad?           @relation("MovimientoUnidadDestino", fields: [unidadDestinoId], references: [id])
  camaOrigen            Cama?             @relation("MovimientoCamaOrigen", fields: [camaOrigenId], references: [id])
  camaDestino           Cama?             @relation("MovimientoCamaDestino", fields: [camaDestinoId], references: [id])

  @@map("movimientos")
}

model Egreso {
  id                       String                @id @default(uuid())
  admisionId               String                @unique @map("admision_id")
  fechaEgreso              DateTime              @default(now()) @map("fecha_egreso")
  horaEgreso               DateTime              @default(now()) @map("hora_egreso")
  diagnosticoSalida        String                @map("diagnostico_salida") // Código CIE-10/11
  descripcionDiagnostico   String                @map("descripcion_diagnostico")
  resumenClinico           String                @db.Text @map("resumen_clinico")
  tratamientoDomiciliario  String?               @db.Text @map("tratamiento_domiciliario")
  recomendaciones          String?               @db.Text
  profesionalResponsableId String                @map("profesional_responsable_id") @db.Uuid
  tipoEgreso               TipoEgreso            @map("tipo_egreso")
  estadoPaciente           EstadoPacienteEgreso  @map("estado_paciente")
  requiereControl          Boolean               @default(false) @map("requiere_control")
  fechaControl             DateTime?             @map("fecha_control") @db.Date
  observaciones            String?               @db.Text
  firmaDigital             String?               @map("firma_digital") // Hash de la firma
  createdAt                DateTime              @default(now()) @map("created_at")
  updatedAt                DateTime              @updatedAt @map("updated_at")

  // Relaciones
  admision                 Admision              @relation(fields: [admisionId], references: [id], onDelete: Cascade)

  @@map("egresos")
}

// ===================================
// ENUMS PARA HOSPITALIZACIÓN
// ===================================

enum EstadoCama {
  Disponible
  Ocupada
  Mantenimiento
  Reservada
}

enum EstadoAdmision {
  Activa
  Egresada
  Cancelada
}

enum TipoMovimiento {
  Ingreso
  Traslado
  CambioCama
  CambioUnidad
  Egreso
}

enum TipoEgreso {
  AltaMedica
  Remision
  Voluntario
  Fallecimiento
  Fuga
}

enum EstadoPacienteEgreso {
  Mejorado
  Estable
  Complicado
  Fallecido
}

// ===================================
// MÓDULO DE FACTURACIÓN Y ÓRDENES
// ===================================

enum EstadoOrdenMedica {
  Pendiente
  EnProceso
  Completada
  Cancelada
}

enum PrioridadOrden {
  Normal
  Urgente
}

enum EstadoOrdenMedicamento {
  Pendiente
  Preparada
  Despachada
  Cancelada
}

enum EstadoFactura {
  Pendiente
  Parcial
  Pagada
  Cancelada
  Vencida
}

enum TipoItemFactura {
  Consulta
  OrdenMedica
  OrdenMedicamento
  Hospitalizacion
  Otro
}

enum MetodoPago {
  Efectivo
  Tarjeta
  Transferencia
  EPS
  Otro
}

// Paquetes de hospitalización por tipo de unidad
model PaqueteHospitalizacion {
  id                String    @id @default(uuid())
  nombre            String    // "UCI Adultos", "Hospitalización General", etc.
  descripcion       String?
  tipoUnidad        String    // Debe coincidir con Unidad.tipo
  precioDia         Decimal   @map("precio_dia") @db.Decimal(10, 2)
  incluye           String?   @db.Text // Descripción de lo que incluye
  activo            Boolean   @default(true)
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@map("paquetes_hospitalizacion")
}

// Órdenes médicas (exámenes y procedimientos)
model OrdenMedica {
  id                        String              @id @default(uuid())
  pacienteId                String              @map("paciente_id")
  citaId                    String?             @map("cita_id")
  admisionId                String?             @map("admision_id")
  examenProcedimientoId     String              @map("examen_procedimiento_id") @db.Uuid
  doctorId                  String              @map("doctor_id") @db.Uuid
  estado                    EstadoOrdenMedica   @default(Pendiente)
  prioridad                 PrioridadOrden      @default(Normal)
  observaciones             String?             @db.Text
  resultados                String?             @db.Text
  archivoResultado          String?             @map("archivo_resultado")
  precioAplicado            Decimal             @map("precio_aplicado") @db.Decimal(10, 2)
  fechaOrden                DateTime            @default(now()) @map("fecha_orden")
  fechaEjecucion            DateTime?           @map("fecha_ejecucion")
  ejecutadoPor              String?             @map("ejecutado_por") @db.Uuid
  createdAt                 DateTime            @default(now()) @map("created_at")
  updatedAt                 DateTime            @updatedAt @map("updated_at")

  paciente                  Paciente            @relation(fields: [pacienteId], references: [id], onDelete: Cascade)
  cita                      Cita?               @relation(fields: [citaId], references: [id])
  admision                  Admision?           @relation(fields: [admisionId], references: [id])
  examenProcedimiento       ExamenProcedimiento @relation(fields: [examenProcedimientoId], references: [id])
  doctor                    Usuario             @relation("OrdenMedicaDoctor", fields: [doctorId], references: [id])
  ejecutador                Usuario?            @relation("OrdenMedicaEjecutor", fields: [ejecutadoPor], references: [id])
  itemsFactura              FacturaItem[]

  @@map("ordenes_medicas")
}

// Órdenes de medicamentos
model OrdenMedicamento {
  id                String                    @id @default(uuid())
  pacienteId        String                    @map("paciente_id")
  citaId            String?                   @map("cita_id")
  admisionId        String?                   @map("admision_id")
  doctorId          String                    @map("doctor_id") @db.Uuid
  estado            EstadoOrdenMedicamento    @default(Pendiente)
  observaciones     String?                   @db.Text
  recetaDigital     String?                   @map("receta_digital") @db.Text // Indicaciones generales
  archivoReceta     String?                   @map("archivo_receta") // URL del PDF de receta
  total             Decimal                   @db.Decimal(10, 2)
  fechaOrden        DateTime                  @default(now()) @map("fecha_orden")
  fechaDespacho     DateTime?                 @map("fecha_despacho")
  despachadoPor     String?                   @map("despachado_por") @db.Uuid
  createdAt         DateTime                  @default(now()) @map("created_at")
  updatedAt         DateTime                  @updatedAt @map("updated_at")

  paciente          Paciente                  @relation(fields: [pacienteId], references: [id], onDelete: Cascade)
  cita              Cita?                     @relation(fields: [citaId], references: [id])
  admision          Admision?                 @relation(fields: [admisionId], references: [id])
  doctor            Usuario                   @relation("OrdenMedicamentoDoctor", fields: [doctorId], references: [id])
  despachador       Usuario?                  @relation("OrdenMedicamentoDespachador", fields: [despachadoPor], references: [id])
  items             OrdenMedicamentoItem[]
  itemsFactura      FacturaItem[]

  @@map("ordenes_medicamentos")
}

// Items de una orden de medicamento
model OrdenMedicamentoItem {
  id                    String              @id @default(uuid())
  ordenMedicamentoId    String              @map("orden_medicamento_id")
  productoId            String              @map("producto_id")
  cantidad              Int
  precioUnitario        Decimal             @map("precio_unitario") @db.Decimal(10, 2)
  descuento             Decimal             @default(0) @db.Decimal(10, 2)
  subtotal              Decimal             @db.Decimal(10, 2)
  indicaciones          String?             @db.Text // "1 tableta cada 8 horas por 7 días"
  createdAt             DateTime            @default(now()) @map("created_at")

  ordenMedicamento      OrdenMedicamento    @relation(fields: [ordenMedicamentoId], references: [id], onDelete: Cascade)
  producto              Producto            @relation(fields: [productoId], references: [id])

  @@map("ordenes_medicamentos_items")
}

// Facturas
model Factura {
  id                String          @id @default(uuid())
  numero            String          @unique // Ej: "F-2025-00001"
  pacienteId        String          @map("paciente_id")
  estado            EstadoFactura   @default(Pendiente)
  subtotal          Decimal         @db.Decimal(10, 2)
  descuentos        Decimal         @default(0) @db.Decimal(10, 2)
  impuestos         Decimal         @default(0) @db.Decimal(10, 2)
  total             Decimal         @db.Decimal(10, 2)
  saldoPendiente    Decimal         @map("saldo_pendiente") @db.Decimal(10, 2)
  observaciones     String?         @db.Text
  
  // Información EPS
  cubiertoPorEPS    Boolean         @default(false) @map("cubierto_por_eps")
  epsAutorizacion   String?         @map("eps_autorizacion")
  montoEPS          Decimal?        @map("monto_eps") @db.Decimal(10, 2)
  montoPaciente     Decimal?        @map("monto_paciente") @db.Decimal(10, 2)
  
  fechaEmision      DateTime        @default(now()) @map("fecha_emision")
  fechaVencimiento  DateTime?       @map("fecha_vencimiento")
  creadaPor         String?         @map("creada_por") @db.Uuid
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")

  paciente          Paciente        @relation(fields: [pacienteId], references: [id], onDelete: Cascade)
  creador           Usuario?        @relation(fields: [creadaPor], references: [id])
  items             FacturaItem[]
  pagos             Pago[]

  @@map("facturas")
}

// Items de factura
model FacturaItem {
  id                    String              @id @default(uuid())
  facturaId             String              @map("factura_id")
  tipo                  TipoItemFactura
  descripcion           String
  cantidad              Int                 @default(1)
  precioUnitario        Decimal             @map("precio_unitario") @db.Decimal(10, 2)
  descuento             Decimal             @default(0) @db.Decimal(10, 2)
  subtotal              Decimal             @db.Decimal(10, 2)
  
  // Referencias opcionales según tipo
  citaId                String?             @map("cita_id")
  ordenMedicaId         String?             @map("orden_medica_id")
  ordenMedicamentoId    String?             @map("orden_medicamento_id")
  admisionId            String?             @map("admision_id")
  
  createdAt             DateTime            @default(now()) @map("created_at")

  factura               Factura             @relation(fields: [facturaId], references: [id], onDelete: Cascade)
  cita                  Cita?               @relation(fields: [citaId], references: [id])
  ordenMedica           OrdenMedica?        @relation(fields: [ordenMedicaId], references: [id])
  ordenMedicamento      OrdenMedicamento?   @relation(fields: [ordenMedicamentoId], references: [id])
  admision              Admision?           @relation(fields: [admisionId], references: [id])

  @@map("facturas_items")
}

// Pagos
model Pago {
  id                String        @id @default(uuid())
  facturaId         String        @map("factura_id")
  monto             Decimal       @db.Decimal(10, 2)
  metodoPago        MetodoPago    @map("metodo_pago")
  referencia        String?       // Número de transacción, cheque, etc.
  observaciones     String?       @db.Text
  fechaPago         DateTime      @default(now()) @map("fecha_pago")
  registradoPor     String?       @map("registrado_por") @db.Uuid
  createdAt         DateTime      @default(now()) @map("created_at")

  factura           Factura       @relation(fields: [facturaId], references: [id], onDelete: Cascade)
  registrador       Usuario?      @relation(fields: [registradoPor], references: [id])

  @@map("pagos")
}

// ===================================
// MÓDULO: HISTORIA CLÍNICA ELECTRÓNICA (HCE)
// ===================================

// Evoluciones Clínicas (Formato SOAP)
model EvolucionClinica {
  id                    String              @id @default(uuid())
  pacienteId            String              @map("paciente_id")
  admisionId            String?             @map("admision_id")
  citaId                String?             @map("cita_id")
  doctorId              String              @map("doctor_id") @db.Uuid
  
  // Estructura SOAP
  subjetivo             String              @db.Text  // Síntomas relatados por el paciente
  objetivo              String              @db.Text  // Hallazgos del examen físico
  analisis              String              @db.Text  // Diagnóstico e interpretación
  plan                  String              @db.Text  // Plan de tratamiento
  
  // Metadatos
  tipoEvolucion         TipoEvolucion
  fechaEvolucion        DateTime            @default(now()) @map("fecha_evolucion")
  turno                 String?             // Mañana, Tarde, Noche
  areaHospitalizacion   String?             @map("area_hospitalizacion") // UCI, Piso, etc.
  
  // Firma Digital
  firmada               Boolean             @default(false)
  firmaDigital          String?             @map("firma_digital") @db.Text
  hashRegistro          String?             @map("hash_registro") // SHA-256
  fechaFirma            DateTime?           @map("fecha_firma")
  ipRegistro            String?             @map("ip_registro")
  
  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @updatedAt @map("updated_at")

  // Relaciones
  paciente              Paciente            @relation(fields: [pacienteId], references: [id], onDelete: Cascade)
  doctor                Usuario             @relation("EvolucionDoctor", fields: [doctorId], references: [id])
  admision              Admision?           @relation(fields: [admisionId], references: [id])
  cita                  Cita?               @relation(fields: [citaId], references: [id])
  diagnosticos          DiagnosticoHCE[]
  
  @@map("evoluciones_clinicas")
}

// Signos Vitales
model SignoVital {
  id                    String    @id @default(uuid())
  pacienteId            String    @map("paciente_id")
  admisionId            String?   @map("admision_id")
  citaId                String?   @map("cita_id")
  registradoPor         String    @map("registrado_por") @db.Uuid
  
  // Signos vitales estándar
  temperatura           Decimal?  @db.Decimal(4, 1)  // °C
  presionSistolica      Int?      @map("presion_sistolica")  // mmHg
  presionDiastolica     Int?      @map("presion_diastolica") // mmHg
  frecuenciaCardiaca    Int?      @map("frecuencia_cardiaca") // bpm
  frecuenciaRespiratoria Int?     @map("frecuencia_respiratoria") // rpm
  saturacionOxigeno     Decimal?  @map("saturacion_oxigeno") @db.Decimal(5, 2) // %
  
  // Antropometría
  peso                  Decimal?  @db.Decimal(6, 2)  // kg
  talla                 Decimal?  @db.Decimal(5, 2)  // cm
  imc                   Decimal?  @db.Decimal(5, 2)  // Calculado automáticamente
  perimetroCefalico     Decimal?  @map("perimetro_cefalico") @db.Decimal(5, 2) // cm (pediátrico)
  
  // Control de dolor (Escala EVA 0-10)
  escalaDolor           Int?      @map("escala_dolor")
  
  // Metadatos
  turno                 String?   // Mañana, Tarde, Noche
  fechaRegistro         DateTime  @default(now()) @map("fecha_registro")
  observaciones         String?   @db.Text
  
  // Alertas generadas automáticamente
  alertaGenerada        Boolean   @default(false) @map("alerta_generada")
  
  createdAt             DateTime  @default(now()) @map("created_at")

  // Relaciones
  paciente              Paciente  @relation(fields: [pacienteId], references: [id], onDelete: Cascade)
  admision              Admision? @relation(fields: [admisionId], references: [id])
  cita                  Cita?     @relation(fields: [citaId], references: [id])
  registrador           Usuario   @relation("SignoVitalRegistrador", fields: [registradoPor], references: [id])
  
  @@map("signos_vitales")
}

// Diagnósticos HCE (con código CIE-11)
model DiagnosticoHCE {
  id                    String              @id @default(uuid())
  pacienteId            String              @map("paciente_id")
  evolucionId           String?             @map("evolucion_id")
  admisionId            String?             @map("admision_id")
  doctorId              String              @map("doctor_id") @db.Uuid
  
  // Clasificación diagnóstica
  codigoCIE11           String              @map("codigo_cie11")  // Ej: "2E60" o búsqueda texto
  descripcionCIE11      String              @map("descripcion_cie11") @db.Text
  tipoDiagnostico       TipoDiagnosticoHCE  @map("tipo_diagnostico")
  estadoDiagnostico     EstadoDiagnosticoHCE @map("estado_diagnostico")
  
  // Si es diagnóstico diferencial
  esDiferencial         Boolean             @default(false) @map("es_diferencial")
  
  // Detalles clínicos
  observaciones         String?             @db.Text
  fechaDiagnostico      DateTime            @default(now()) @map("fecha_diagnostico")
  fechaResolucion       DateTime?           @map("fecha_resolucion")
  
  // Severidad según valoración clínica
  severidad             SeveridadHCE?
  
  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @updatedAt @map("updated_at")

  // Relaciones
  paciente              Paciente            @relation(fields: [pacienteId], references: [id], onDelete: Cascade)
  evolucion             EvolucionClinica?   @relation(fields: [evolucionId], references: [id])
  admision              Admision?           @relation(fields: [admisionId], references: [id])
  doctor                Usuario             @relation("DiagnosticoHCEDoctor", fields: [doctorId], references: [id])
  
  @@map("diagnosticos_hce")
}

// Alertas Clínicas
model AlertaClinica {
  id                    String        @id @default(uuid())
  pacienteId            String        @map("paciente_id")
  
  // Tipo y contenido de la alerta
  tipoAlerta            TipoAlertaHCE
  severidad             SeveridadHCE
  titulo                String
  descripcion           String        @db.Text
  
  // Contexto y origen
  origen                String?       // "Alergias", "Signos Vitales", "Medicamentos"
  valorReferencia       String?       @map("valor_referencia")
  
  // Control de visibilidad
  visiblePara           String[]      @map("visible_para")  // Array de roles: ["DOCTOR", "NURSE"]
  colorAlerta           String        @default("red") @map("color_alerta")
  iconoAlerta           String?       @map("icono_alerta")
  
  // Estado
  activa                Boolean       @default(true)
  reconocidaPor         String?       @map("reconocida_por") @db.Uuid
  fechaReconocimiento   DateTime?     @map("fecha_reconocimiento")
  
  // Fechas
  fechaAlerta           DateTime      @default(now()) @map("fecha_alerta")
  fechaExpiracion       DateTime?     @map("fecha_expiracion")
  
  createdAt             DateTime      @default(now()) @map("created_at")

  // Relaciones
  paciente              Paciente      @relation(fields: [pacienteId], references: [id], onDelete: Cascade)
  reconocedor           Usuario?      @relation("AlertaReconocedor", fields: [reconocidaPor], references: [id])
  
  @@map("alertas_clinicas")
}

// Auditoría HCE (Trazabilidad completa)
model AuditoriaHCE {
  id                    String            @id @default(uuid())
  
  // Qué se modificó
  entidad               String            // "EvolucionClinica", "DiagnosticoHCE", etc.
  entidadId             String            @map("entidad_id")
  accion                AccionAuditoriaHCE
  
  // Quién lo hizo
  usuarioId             String            @map("usuario_id") @db.Uuid
  nombreUsuario         String            @map("nombre_usuario")
  rol                   String
  
  // Cuándo y dónde
  fechaAccion           DateTime          @default(now()) @map("fecha_accion")
  ipOrigen              String?           @map("ip_origen")
  navegador             String?
  dispositivo           String?
  
  // Qué cambió (JSON para flexibilidad)
  valoresAnteriores     Json?             @map("valores_anteriores")
  valoresNuevos         Json?             @map("valores_nuevos")
  
  // Firma digital del registro
  hashRegistro          String            @map("hash_registro")  // SHA-256
  
  createdAt             DateTime          @default(now()) @map("created_at")

  // Relaciones
  usuario               Usuario           @relation("AuditoriaHCEUsuario", fields: [usuarioId], references: [id])
  
  @@map("auditoria_hce")
}

// ===================================
// ENUMS PARA HCE
// ===================================

enum TipoEvolucion {
  Ingreso
  Seguimiento
  Alta
  Urgencia
  Interconsulta
  Prequirurgico
  Postquirurgico
}

enum TipoDiagnosticoHCE {
  Principal
  Secundario
  Complicacion
  Comorbilidad
  Diferencial
}

enum EstadoDiagnosticoHCE {
  Activo
  EnControl
  Resuelto
  Descartado
}

enum SeveridadHCE {
  Leve
  Moderada
  Grave
  Critica
}

enum TipoAlertaHCE {
  AlergiaMedicamento
  Intolerancia
  RestriccionMovilidad
  Aislamiento
  RiesgoCaidas
  Recordatorio
  SignoVitalCritico
  ResultadoCritico
  InteraccionMedicamentosa
}

enum AccionAuditoriaHCE {
  Creacion
  Modificacion
  Eliminacion
  Visualizacion
  Firma
  Descarga
  Impresion
}

enum EstadoInterconsulta {
  Solicitada
  EnProceso
  Respondida
  Cancelada
}

enum PrioridadInterconsulta {
  Baja
  Media
  Alta
  Urgente
}

// Modelo de Interconsultas
model Interconsulta {
  id                    String                   @id @default(uuid())
  admisionId            String
  pacienteId            String
  especialidadSolicitada String                  @db.VarChar(255)
  medicoSolicitanteId   String                   @db.Uuid
  medicoEspecialistaId  String?                  @db.Uuid
  fechaSolicitud        DateTime                 @default(now())
  fechaRespuesta        DateTime?
  motivoConsulta        String                   @db.Text
  antecedentesRelevantes String?                 @db.Text
  examenesSolicitados   String?                  @db.Text
  diagnosticoPresuntivo String?                  @db.Text
  prioridad             PrioridadInterconsulta   @default(Media)
  estado                EstadoInterconsulta      @default(Solicitada)
  
  // Respuesta del especialista
  evaluacionEspecialista String?                 @db.Text
  diagnosticoEspecialista String?                @db.Text
  recomendaciones       String?                  @db.Text
  requiereSeguimiento   Boolean                  @default(false)
  fechaSeguimiento      DateTime?
  observaciones         String?                  @db.Text
  
  createdAt             DateTime                 @default(now())
  updatedAt             DateTime                 @updatedAt
  
  // Relaciones
  admision              Admision                 @relation(fields: [admisionId], references: [id], onDelete: Cascade)
  paciente              Paciente                 @relation(fields: [pacienteId], references: [id])
  medicoSolicitante     Usuario                  @relation("InterconsultasSolicitadas", fields: [medicoSolicitanteId], references: [id])
  medicoEspecialista    Usuario?                 @relation("InterconsultasRespondidas", fields: [medicoEspecialistaId], references: [id])
  
  @@index([admisionId])
  @@index([pacienteId])
  @@index([estado])
  @@index([fechaSolicitud])
  @@map("interconsultas")
}

enum TipoProcedimiento {
  Diagnostico
  Terapeutico
  Quirurgico
  Intervencionista
  Rehabilitacion
  Otro
}

enum EstadoProcedimiento {
  Programado
  EnProceso
  Completado
  Cancelado
  Diferido
}

// Modelo de Procedimientos
model Procedimiento {
  id                    String                @id @default(uuid())
  admisionId            String?
  citaId                String?
  pacienteId            String
  medicoResponsableId   String                @db.Uuid
  
  // Información del procedimiento
  nombre                String                @db.VarChar(255)
  tipo                  TipoProcedimiento     @default(Terapeutico)
  descripcion           String                @db.Text
  indicacion            String                @db.Text
  
  // Programación
  fechaProgramada       DateTime?
  fechaRealizada        DateTime?
  duracionEstimada      Int?                  // en minutos
  duracionReal          Int?                  // en minutos
  estado                EstadoProcedimiento   @default(Programado)
  
  // Ejecución
  tecnicaUtilizada      String?               @db.Text
  hallazgos             String?               @db.Text
  complicaciones        String?               @db.Text
  resultados            String?               @db.Text
  
  // Insumos y recursos
  insumosUtilizados     String?               @db.Text
  equipoMedico          String?               @db.Text
  personalAsistente     String?               @db.Text
  
  // Seguimiento
  recomendacionesPost   String?               @db.Text
  cuidadosEspeciales    String?               @db.Text
  observaciones         String?               @db.Text
  
  // Firma digital
  firmaMedicoId         String?               @db.Uuid
  fechaFirma            DateTime?
  
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  // Relaciones
  admision              Admision?             @relation(fields: [admisionId], references: [id], onDelete: Cascade)
  cita                  Cita?                 @relation(fields: [citaId], references: [id])
  paciente              Paciente              @relation(fields: [pacienteId], references: [id])
  medicoResponsable     Usuario               @relation("ProcedimientoResponsable", fields: [medicoResponsableId], references: [id])
  medicoFirma           Usuario?              @relation("ProcedimientoFirma", fields: [firmaMedicoId], references: [id])
  
  @@index([admisionId])
  @@index([pacienteId])
  @@index([estado])
  @@index([fechaProgramada])
  @@index([fechaRealizada])
  @@map("procedimientos")
}

// ============================================
// MÓDULO DE PRESCRIPCIÓN MÉDICA
// ============================================

enum ViaPrescripcion {
  Oral
  Intravenosa
  Intramuscular
  Subcutanea
  Topica
  Inhalatoria
  Rectal
  Sublingual
  Oftaelmica
  Otica
  Nasal
  Otra
}

enum FrecuenciaPrescripcion {
  Unica
  Cada4Horas
  Cada6Horas
  Cada8Horas
  Cada12Horas
  Cada24Horas
  PRN // Por razón necesaria
  Continua
  Otra
}

enum EstadoPrescripcion {
  Activa
  Suspendida
  Completada
  Cancelada
}

enum EstadoAdministracion {
  Programada
  Administrada
  Omitida
  Rechazada
}

enum TurnoEnfermeria {
  Manana
  Tarde
  Noche
}

enum TipoNotaEnfermeria {
  Evolucion
  Observacion
  Incidente
  CambioTurno
  Procedimiento
}

// NOTA: Se usa el modelo Producto existente como catálogo de medicamentos
// El modelo Producto ya tiene: principioActivo, concentracion, presentacion,
// viaAdministracion, requiereReceta, laboratorio, etc.

// Prescripción médica (receta)
model Prescripcion {
  id                    String                @id @default(uuid())
  pacienteId            String
  admisionId            String?
  citaId                String?
  medicoId              String                @db.Uuid
  
  // Información de la prescripción
  fechaPrescripcion     DateTime              @default(now())
  fechaInicio           DateTime              @default(now())
  fechaFin              DateTime?
  diagnostico           String?               @db.Text
  observaciones         String?               @db.Text
  
  estado                EstadoPrescripcion    @default(Activa)
  
  // Firma digital
  firmaMedicoId         String?               @db.Uuid
  fechaFirma            DateTime?
  
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  // Relaciones
  paciente              Paciente              @relation(fields: [pacienteId], references: [id])
  admision              Admision?             @relation(fields: [admisionId], references: [id], onDelete: Cascade)
  cita                  Cita?                 @relation(fields: [citaId], references: [id])
  medico                Usuario               @relation("PrescripcionMedico", fields: [medicoId], references: [id])
  medicoFirma           Usuario?              @relation("PrescripcionFirma", fields: [firmaMedicoId], references: [id])
  medicamentos          PrescripcionMedicamento[]
  
  @@index([pacienteId])
  @@index([admisionId])
  @@index([estado])
  @@index([fechaPrescripcion])
  @@map("prescripciones")
}

// Medicamentos dentro de una prescripción
model PrescripcionMedicamento {
  id                    String                @id @default(uuid())
  prescripcionId        String
  productoId            String // Referencia a Producto (medicamento)
  
  // Indicación específica
  dosis                 String                @db.VarChar(100) // "500mg", "1 tableta"
  via                   ViaPrescripcion       @default(Oral)
  frecuencia            FrecuenciaPrescripcion @default(Cada8Horas)
  frecuenciaDetalle     String?               @db.VarChar(255) // "Cada 8 horas durante 7 días"
  duracionDias          Int?
  cantidadTotal         String?               @db.VarChar(50) // "30 tabletas"
  
  // Instrucciones
  instrucciones         String?               @db.Text // "Tomar con alimentos", "No tomar con leche"
  indicacionEspecial    String?               @db.Text // "Solo si hay dolor", "Suspender si hay rash"
  
  // Control
  prn                   Boolean               @default(false) // Por razón necesaria
  suspendido            Boolean               @default(false)
  fechaSuspension       DateTime?
  motivoSuspension      String?               @db.Text
  
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  // Relaciones
  prescripcion          Prescripcion          @relation(fields: [prescripcionId], references: [id], onDelete: Cascade)
  producto              Producto              @relation("PrescripcionProducto", fields: [productoId], references: [id])
  administraciones      AdministracionMedicamento[]
  
  @@index([prescripcionId])
  @@index([productoId])
  @@map("prescripciones_medicamentos")
}

// Registro de administración de medicamentos (Enfermería)
model AdministracionMedicamento {
  id                            String                      @id @default(uuid())
  prescripcionMedicamentoId     String
  pacienteId                    String
  
  // Programación
  fechaProgramada               DateTime
  horaProgramada                String                      @db.VarChar(10) // "08:00", "14:00"
  
  // Administración
  fechaAdministracion           DateTime?
  administradoPor               String?                     @db.Uuid // Enfermera/o
  estado                        EstadoAdministracion        @default(Programada)
  
  // Detalles
  dosisAdministrada             String?                     @db.VarChar(100)
  viaAdministrada               String?                     @db.VarChar(50)
  observaciones                 String?                     @db.Text
  reaccionAdversa               Boolean                     @default(false)
  descripcionReaccion           String?                     @db.Text
  
  // Si fue omitida o rechazada
  motivoOmision                 String?                     @db.Text
  motivoRechazo                 String?                     @db.Text
  
  createdAt                     DateTime                    @default(now())
  updatedAt                     DateTime                    @updatedAt
  
  // Relaciones
  prescripcionMedicamento       PrescripcionMedicamento     @relation(fields: [prescripcionMedicamentoId], references: [id], onDelete: Cascade)
  paciente                      Paciente                    @relation(fields: [pacienteId], references: [id])
  enfermera                     Usuario?                    @relation("AdministracionEnfermera", fields: [administradoPor], references: [id])
  
  @@index([prescripcionMedicamentoId])
  @@index([pacienteId])
  @@index([fechaProgramada])
  @@index([estado])
  @@map("administraciones_medicamentos")
}

// Asignación de enfermeras a pisos/unidades
model AsignacionEnfermeria {
  id              String              @id @default(uuid())
  enfermeraId     String              @map("enfermera_id") @db.Uuid
  unidadId        String              @map("unidad_id")
  piso            Int?                // Número de piso (puede ser null si es toda la unidad)
  turno           TurnoEnfermeria
  fechaInicio     DateTime            @default(now()) @map("fecha_inicio")
  fechaFin        DateTime?           @map("fecha_fin") // null = asignación activa
  activo          Boolean             @default(true)
  createdAt       DateTime            @default(now()) @map("created_at")
  
  // Relaciones
  enfermera       Usuario             @relation("EnfermeraAsignaciones", fields: [enfermeraId], references: [id], onDelete: Cascade)
  unidad          Unidad              @relation(fields: [unidadId], references: [id])
  
  @@index([enfermeraId])
  @@index([unidadId])
  @@index([activo])
  @@map("asignaciones_enfermeria")
}

// Notas de enfermería (separadas de evoluciones médicas)
model NotaEnfermeria {
  id              String              @id @default(uuid())
  admisionId      String              @map("admision_id")
  pacienteId      String              @map("paciente_id")
  enfermeraId     String              @map("enfermera_id") @db.Uuid
  
  // Contenido de la nota
  tipoNota        TipoNotaEnfermeria  @map("tipo_nota")
  titulo          String?             @db.VarChar(255)
  contenido       String              @db.Text
  
  // Contexto
  turno           TurnoEnfermeria
  fechaHora       DateTime            @default(now()) @map("fecha_hora")
  
  // Prioridad y seguimiento
  requiereSeguimiento Boolean         @default(false) @map("requiere_seguimiento")
  seguimientoPor  String?             @map("seguimiento_por") // Médico, Enfermera jefe, etc.
  
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")
  
  // Relaciones
  admision        Admision            @relation(fields: [admisionId], references: [id], onDelete: Cascade)
  paciente        Paciente            @relation(fields: [pacienteId], references: [id])
  enfermera       Usuario             @relation("NotasEnfermera", fields: [enfermeraId], references: [id])
  
  @@index([admisionId])
  @@index([pacienteId])
  @@index([enfermeraId])
  @@index([fechaHora])
  @@map("notas_enfermeria")
}

// Modelo de permisos por rol
model RolePermiso {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  rol       String   @db.VarChar(50)
  modulo    String   @db.VarChar(100)
  acceso    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @map("updated_at")

  @@unique([rol, modulo])
  @@map("role_permisos")
}

// Campos adicionales para citas mejoradas (agregar al modelo Cita)
// tipoCita: 'Especialidad', 'Examen', 'Procedimiento'
// examenProcedimientoId: referencia si es examen o procedimiento
// duracionMinutos: duración estimada
// costo: costo de la consulta

// ===================================
// MÓDULO DE URGENCIAS
// ===================================

enum CategoriaManchester {
  Rojo      // Reanimación - Inmediato
  Naranja   // Muy Urgente - 10 min
  Amarillo  // Urgente - 60 min
  Verde     // Poco Urgente - 120 min
  Azul      // No Urgente - 240 min
}

enum EstadoUrgencia {
  Triaje
  Espera
  EnAtencion
  Completada
  Alta
  Hospitalizado
  Remitido
  Cancelado
}

enum DisposicionUrgencia {
  Alta
  Hospitalizar
  Remitir
  Fallecido
  Observacion
}

model AtencionUrgencia {
  id                      String                @id @default(uuid())
  pacienteId              String                @map("paciente_id")
  
  // Triaje Manchester
  categoriaManchester     CategoriaManchester   @map("categoria_manchester")
  nivelUrgencia           String                @map("nivel_urgencia") // "Reanimación", "Muy Urgente", etc.
  prioridad               Int                   // 1-5 (1 más urgente)
  
  // Información de Llegada
  motivoConsulta          String                @db.Text @map("motivo_consulta")
  horaLlegada             DateTime              @default(now()) @map("hora_llegada")
  horaTriaje              DateTime?             @map("hora_triaje")
  medioLlegada            String?               @map("medio_llegada") // Ambulancia, Particular, Remitido
  acompanante             String?               // Nombre del acompañante
  
  // Signos Vitales Iniciales (Triaje)
  presionSistolica        Int?                  @map("presion_sistolica")
  presionDiastolica       Int?                  @map("presion_diastolica")
  frecuenciaCardiaca      Int?                  @map("frecuencia_cardiaca")
  frecuenciaRespiratoria  Int?                  @map("frecuencia_respiratoria")
  temperatura             Decimal?              @db.Decimal(4, 1)
  saturacionOxigeno       Decimal?              @map("saturacion_oxigeno") @db.Decimal(5, 2)
  escalaGlasgow           Int?                  @map("escala_glasgow")
  escalaDolor             Int?                  @map("escala_dolor") // 0-10
  
  // Atención Médica
  estado                  EstadoUrgencia        @default(Triaje)
  areaAsignada            String?               @map("area_asignada") // "Shock", "Consultorio 1", "Observación"
  medicoAsignadoId        String?               @map("medico_asignado_id") @db.Uuid
  enfermeraAsignadaId     String?               @map("enfermera_asignada_id") @db.Uuid
  horaInicioAtencion      DateTime?             @map("hora_inicio_atencion")
  horaFinAtencion         DateTime?             @map("hora_fin_atencion")
  
  // Diagnóstico y Tratamiento
  diagnosticoInicial      String?               @db.Text @map("diagnostico_inicial")
  tratamientoAplicado     String?               @db.Text @map("tratamiento_aplicado")
  observaciones           String?               @db.Text
  
  // Disposición Final
  disposicion             DisposicionUrgencia?
  indicacionesAlta        String?               @db.Text @map("indicaciones_alta")
  citaId                  String?               @map("cita_id") // Si se programa cita de seguimiento
  admisionId              String?               @map("admision_id") // Si se hospitaliza
  
  createdAt               DateTime              @default(now()) @map("created_at")
  updatedAt               DateTime              @updatedAt @map("updated_at")
  
  // Relaciones
  paciente                Paciente              @relation(fields: [pacienteId], references: [id], onDelete: Cascade)
  medicoAsignado          Usuario?              @relation("UrgenciaMedico", fields: [medicoAsignadoId], references: [id])
  enfermeraAsignada       Usuario?              @relation("UrgenciaEnfermera", fields: [enfermeraAsignadaId], references: [id])
  cita                    Cita?                 @relation(fields: [citaId], references: [id])
  admision                Admision?             @relation(fields: [admisionId], references: [id])
  
  @@map("atenciones_urgencias")
}

// ============================================
// MÓDULO DE TALENTO HUMANO (RRHH)
// ============================================

model tHDepartamento {
  id          String       @id @default(uuid())
  nombre      String
  descripcion String?
  responsable String?      // ID del empleado responsable
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  empleados   tHEmpleado[]
  vacantes    tHVacante[]
}

model tHCargo {
  id          String       @id @default(uuid())
  nombre      String
  descripcion String?
  nivel       String?      // ESTRATEGICO, TACTICO, OPERATIVO
  salarioMin  Decimal?     @db.Decimal(12, 2)
  salarioMax  Decimal?     @db.Decimal(12, 2)
  activo      Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  empleados   tHEmpleado[]
  vacantes    tHVacante[]
}

model tHEmpleado {
  id                String    @id @default(uuid())
  usuarioId         String?   @unique @db.Uuid // Vinculación con usuario del sistema
  nombre            String
  apellido          String
  tipoDocumento     String
  documento         String    @unique
  emailPersonal     String?
  emailCorporativo  String?   @unique
  telefono          String?
  direccion         String?
  fechaNacimiento   DateTime?
  genero            String?
  estadoCivil       String?
  
  // Datos laborales
  departamentoId    String?
  cargoId           String?
  fechaIngreso      DateTime
  tipoEmpleado      String    // MEDICO, ENFERMERIA, ADMINISTRATIVO, etc.
  estado            String    // ACTIVO, VACACIONES, INCAPACIDAD, RETIRADO
  jefeDirectoId     String?
  
  // Datos bancarios
  banco             String?
  tipoCuenta        String?
  numeroCuenta      String?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relaciones
  usuario           Usuario?         @relation(fields: [usuarioId], references: [id])
  departamentoRel   tHDepartamento?  @relation(fields: [departamentoId], references: [id])
  cargo             tHCargo?         @relation(fields: [cargoId], references: [id])
  jefeDirecto       tHEmpleado?      @relation("JefeSubordinado", fields: [jefeDirectoId], references: [id])
  subordinados      tHEmpleado[]     @relation("JefeSubordinado")
  
  contratos         tHContrato[]
  movimientos       tHMovimiento[]
  asistencias       tHAsistencia[]
  vacaciones        tHVacacion[]
  permisos          tHPermiso[]
  evaluacionesHechas tHEvaluacionDesempeno[]  @relation("Evaluador")
  evaluacionesRecibidas tHEvaluacionDesempeno[] @relation("Evaluado")
  feedbackEnviado   tHFeedback[]     @relation("FeedbackAutor")
  feedbackRecibido  tHFeedback[]     @relation("FeedbackDestino")
  objetivos         tHObjetivo[]
  capacitaciones    tHAsistenteCapacitacion[]
  beneficios        tHBeneficioEmpleado[]
  reconocimientos   tHReconocimiento[]
  asistenciasEventos tHAsistenteEvento[]
  detallesNomina    tHNominaDetalle[]
  novedadesNomina   tHNovedadNomina[]
  asignacionesTurno tHAsignacionTurno[]
}

model tHContrato {
  id              String    @id @default(uuid())
  empleadoId      String
  numeroContrato  String?   @unique
  tipoContrato    String    // TERMINO_FIJO, INDEFINIDO, OBRA_LABOR, PRESTACION_SERVICIOS
  fechaInicio     DateTime
  fechaFin        DateTime?
  salarioBase     Decimal   @db.Decimal(12, 2)
  auxTransporte   Boolean   @default(true)
  jornada         String?   // COMPLETA, MEDIO_TIEMPO
  horasSemana     Int?
  cargo           String?   // Cargo específico en el contrato
  funciones       String?   @db.Text
  clausulasAdicionales String? @db.Text
  estado          String    // ACTIVO, TERMINADO, SUSPENDIDO
  fechaTerminacion DateTime?
  motivoTerminacion String?
  documentoUrl    String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  empleado        tHEmpleado @relation(fields: [empleadoId], references: [id])
  modificaciones  tHModificacionContrato[]
}

model tHModificacionContrato {
  id              String    @id @default(uuid())
  contratoId      String
  tipo            String    // SALARIO, CARGO, PRORROGA, OTROSI
  fechaEfectiva   DateTime
  descripcion     String?   @db.Text
  valorAnterior   String?
  valorNuevo      String?
  createdAt       DateTime  @default(now())
  
  contrato        tHContrato @relation(fields: [contratoId], references: [id])
}

model tHMovimiento {
  id              String    @id @default(uuid())
  empleadoId      String
  tipoMovimiento  String    // INGRESO, RETIRO, TRASLADO, ASCENSO
  fechaEfectiva   DateTime
  motivo          String?
  createdAt       DateTime  @default(now())
  
  empleado        tHEmpleado @relation(fields: [empleadoId], references: [id])
}

model tHVacante {
  id              String    @id @default(uuid())
  titulo          String
  descripcion     String    @db.Text
  departamentoId  String?
  cargoId         String?
  numeroVacantes  Int       @default(1)
  tipoContrato    String?
  modalidad       String?   // PRESENCIAL, REMOTO, HIBRIDO
  experienciaMin  Int?      // Años
  salarioMin      Decimal?  @db.Decimal(12, 2)
  salarioMax      Decimal?  @db.Decimal(12, 2)
  requisitos      Json?
  estado          String    // BORRADOR, ABIERTA, CERRADA, CANCELADA
  fechaCierre     DateTime?
  publicadoPor    String?   @db.Uuid
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  departamentoRel tHDepartamento? @relation(fields: [departamentoId], references: [id])
  cargo           tHCargo?        @relation(fields: [cargoId], references: [id])
  candidatos      tHCandidatoVacante[]
}

model tHCandidato {
  id              String    @id @default(uuid())
  nombre          String
  apellido        String
  email           String    @unique
  telefono        String?
  documento       String?
  cvUrl           String?
  cvTexto         String?   @db.Text // Texto extraído para IA
  linkedin        String?
  profesion       String?
  experienciaAnios Int?
  habilidades     String[]
  scoreIA         Int?
  analisisIA      Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  postulaciones   tHCandidatoVacante[]
  entrevistas     tHEntrevista[]
}

model tHCandidatoVacante {
  id              String    @id @default(uuid())
  candidatoId     String
  vacanteId       String
  estado          String    // APLICADO, SCREENING, ENTREVISTA, OFERTA, CONTRATADO, RECHAZADO
  fechaAplicacion DateTime  @default(now())
  scoreMatch      Int?
  notas           String?
  updatedAt       DateTime  @updatedAt
  
  candidato       tHCandidato @relation(fields: [candidatoId], references: [id])
  vacante         tHVacante   @relation(fields: [vacanteId], references: [id])
}

model tHEntrevista {
  id              String    @id @default(uuid())
  candidatoId     String
  vacanteId       String?   // Opcional, puede ser general
  entrevistadorId String    @db.Uuid
  fechaProgramada DateTime
  tipo            String    // TECNICA, RRHH, GERENCIAL
  modalidad       String    // VIRTUAL, PRESENCIAL
  linkReunion     String?
  estado          String    // PROGRAMADA, COMPLETADA, CANCELADA, NO_ASISTIO
  evaluacion      Int?      // 1-5
  observaciones   String?   @db.Text
  respuestas      Json?     // Respuestas estructuradas
  recomendacion   String?   // CONTRATAR, RECHAZAR, SEGUNDA_VISTA
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  candidato       tHCandidato @relation(fields: [candidatoId], references: [id])
  entrevistador   Usuario     @relation(fields: [entrevistadorId], references: [id])
}

model tHPeriodoNomina {
  id              String    @id @default(uuid())
  anio            Int
  mes             Int
  quincena        Int?      // 1 o 2, puede ser null si es mensual
  fechaInicio     DateTime
  fechaFin        DateTime
  fechaPago       DateTime?
  estado          String    // BORRADOR, EN_PROCESO, CERRADO, PAGADO
  totalDevengado  Decimal   @default(0) @db.Decimal(14, 2)
  totalDeducciones Decimal  @default(0) @db.Decimal(14, 2)
  totalNeto       Decimal   @default(0) @db.Decimal(14, 2)
  procesadoPorId  String?   @db.Uuid
  fechaProceso    DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  procesador      Usuario?  @relation(fields: [procesadoPorId], references: [id])
  detalles        tHNominaDetalle[]
  novedades       tHNovedadNomina[]

  @@unique([anio, mes, quincena], name: "anio_mes_quincena")
}

model tHNominaDetalle {
  id              String    @id @default(uuid())
  periodoId       String
  empleadoId      String
  diasTrabajados  Int
  salarioBase     Decimal   @db.Decimal(12, 2)
  auxTransporte   Decimal   @default(0) @db.Decimal(12, 2)
  
  // Devengos
  horasExtras     Decimal   @default(0) @db.Decimal(12, 2)
  comisiones      Decimal   @default(0) @db.Decimal(12, 2)
  bonificaciones  Decimal   @default(0) @db.Decimal(12, 2)
  otrosIngresos   Decimal   @default(0) @db.Decimal(12, 2)
  totalDevengado  Decimal   @db.Decimal(12, 2)
  
  // Deducciones
  saludEmpleado   Decimal   @db.Decimal(12, 2)
  pensionEmpleado Decimal   @db.Decimal(12, 2)
  fondoSolidaridad Decimal  @default(0) @db.Decimal(12, 2)
  retencionFuente Decimal   @default(0) @db.Decimal(12, 2)
  embargos        Decimal   @default(0) @db.Decimal(12, 2)
  prestamos       Decimal   @default(0) @db.Decimal(12, 2)
  otrosDescuentos Decimal   @default(0) @db.Decimal(12, 2)
  totalDeducciones Decimal  @db.Decimal(12, 2)
  
  netoPagar       Decimal   @db.Decimal(12, 2)

  // Aportes Empresa
  saludEmpresa     Decimal   @default(0) @db.Decimal(12, 2)
  pensionEmpresa   Decimal   @default(0) @db.Decimal(12, 2)
  arl              Decimal   @default(0) @db.Decimal(12, 2)
  cajaCompensacion Decimal   @default(0) @db.Decimal(12, 2)
  sena             Decimal   @default(0) @db.Decimal(12, 2)
  icbf             Decimal   @default(0) @db.Decimal(12, 2)

  // Provisiones
  cesantias        Decimal   @default(0) @db.Decimal(12, 2)
  intCesantias     Decimal   @default(0) @db.Decimal(12, 2)
  prima            Decimal   @default(0) @db.Decimal(12, 2)
  vacacionesProv   Decimal   @default(0) @db.Decimal(12, 2)
  
  periodo         tHPeriodoNomina @relation(fields: [periodoId], references: [id])
  empleado        tHEmpleado      @relation(fields: [empleadoId], references: [id])

  @@unique([periodoId, empleadoId], name: "periodoId_empleadoId")
}

model tHNovedadNomina {
  id              String    @id @default(uuid())
  periodoId       String?
  empleadoId      String
  tipo            String    // INCAPACIDAD, LICENCIA, PERMISO_NO_REMUNERADO, HORA_EXTRA, BONIFICACION
  fechaInicio     DateTime
  fechaFin        DateTime?
  cantidad        Decimal?  // Días u horas
  valor           Decimal?  @db.Decimal(12, 2)
  observaciones   String?
  recurrente      Boolean   @default(false)
  estado          String    // PENDIENTE, APROBADO, RECHAZADO, PROCESADO
  aprobadoPor     String?   @db.Uuid
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  periodo         tHPeriodoNomina? @relation(fields: [periodoId], references: [id])
  empleado        tHEmpleado       @relation(fields: [empleadoId], references: [id])
}

model tHAsistencia {
  id              String    @id @default(uuid())
  empleadoId      String
  fecha           DateTime
  horaEntrada     DateTime?
  horaSalida      DateTime?
  horasTrabajadas Decimal?  @db.Decimal(4, 2)
  tipoRegistro    String    @default("MANUAL") // MANUAL, BIOMETRICO, WEB
  ubicacionEntrada String?
  ubicacionSalida  String?
  turnoId         String?
  estado          String    // PRESENTE, TARDANZA, AUSENTE, PERMISO, VACACIONES
  observaciones   String?
  
  empleado        tHEmpleado @relation(fields: [empleadoId], references: [id])
  turno           tHTurno?   @relation(fields: [turnoId], references: [id])

  @@unique([empleadoId, fecha], name: "empleadoId_fecha")
}

model tHTurno {
  id              String    @id @default(uuid())
  nombre          String    // MAÑANA, TARDE, NOCHE, VELITA
  codigo          String?   @unique
  horaInicio      String
  horaFin         String
  color           String?
  activo          Boolean   @default(true)
  asistencias     tHAsistencia[]
  asignaciones    tHAsignacionTurno[]
}

model tHAsignacionTurno {
  id              String    @id @default(uuid())
  empleadoId      String
  turnoId         String
  fechaInicio     DateTime
  fechaFin        DateTime?
  diasSemana      String?   // L,M,X,J,V,S,D
  activo          Boolean   @default(true)
  createdAt       DateTime  @default(now())

  empleado        tHEmpleado @relation(fields: [empleadoId], references: [id])
  turno           tHTurno    @relation(fields: [turnoId], references: [id])
}

model tHVacacion {
  id              String    @id @default(uuid())
  empleadoId      String
  tipo            String    @default("ORDINARIAS") // ORDINARIAS, ANTICIPADAS
  fechaInicio     DateTime
  fechaFin        DateTime
  diasSolicitados Int
  diasHabiles     Int
  estado          String    // PENDIENTE, APROBADA, RECHAZADA, DISFRUTADA
  solicitadoEl    DateTime  @default(now())
  aprobadoPor     String?   @db.Uuid
  fechaAprobacion DateTime?
  observaciones   String?
  
  empleado        tHEmpleado @relation(fields: [empleadoId], references: [id])
  aprobador       Usuario?   @relation(fields: [aprobadoPor], references: [id])
}

model tHPermiso {
  id              String    @id @default(uuid())
  empleadoId      String
  tipo            String    // PERSONAL, MEDICO, CALAMIDAD, ESTUDIO
  fechaInicio     DateTime
  fechaFin        DateTime
  dias            Decimal   @db.Decimal(4, 1)
  remunerado      Boolean   @default(false)
  motivo          String
  estado          String    // PENDIENTE, APROBADA, RECHAZADA
  solicitadoEl    DateTime  @default(now())
  aprobadoPor     String?   @db.Uuid
  fechaAprobacion DateTime?
  adjuntoUrl      String?
  createdAt       DateTime  @default(now())
  
  empleado        tHEmpleado @relation(fields: [empleadoId], references: [id])
  aprobador       Usuario?   @relation(fields: [aprobadoPor], references: [id])
}

model tHPeriodoEvaluacion {
  id              String    @id @default(uuid())
  nombre          String
  anio            Int
  fechaInicio     DateTime
  fechaFin        DateTime
  pesosEvaluadores Json?     // Configuración de pesos
  estado          String    // CONFIGURACION, EN_EVALUACION, CERRADO
  createdAt       DateTime  @default(now())
  
  evaluaciones    tHEvaluacionDesempeno[]
}

model tHEvaluacionDesempeno {
  id              String    @id @default(uuid())
  periodoId       String
  empleadoId      String    // Evaluado
  evaluadorId     String    // Evaluador
  tipoEvaluador   String    // AUTO, JEFE, PAR, SUBALTERNO
  estado          String    // PENDIENTE, EN_PROGRESO, COMPLETADA
  fechaAsignacion DateTime  @default(now())
  fechaCompletado DateTime?
  respuestas      Json?
  scoreTotal      Decimal?  @db.Decimal(5, 2)
  comentarioGeneral String? @db.Text
  areasMejora     String?   @db.Text
  fortalezas      String?   @db.Text
  
  periodo         tHPeriodoEvaluacion @relation(fields: [periodoId], references: [id])
  empleado        tHEmpleado          @relation("Evaluado", fields: [empleadoId], references: [id])
  evaluador       tHEmpleado          @relation("Evaluador", fields: [evaluadorId], references: [id])
}

model tHObjetivo {
  id              String    @id @default(uuid())
  empleadoId      String
  titulo          String
  descripcion     String?
  peso            Int       // Porcentaje
  meta            Decimal?
  valorActual     Decimal?
  progreso        Decimal   @default(0)
  estado          String    // PENDIENTE, EN_PROGRESO, COMPLETADO, CANCELADO
  anio            Int
  fechaLimite     DateTime?
  createdAt       DateTime  @default(now())

  empleado        tHEmpleado @relation(fields: [empleadoId], references: [id])
}

model tHFeedback {
  id              String    @id @default(uuid())
  deParteId       String    // Quien da el feedback
  empleadoId      String    // Quien recibe (destino)
  tipo            String    // RECONOCIMIENTO, MEJORA, SUGERENCIA
  mensaje         String    @db.Text
  esAnonimo       Boolean   @default(false)
  createdAt       DateTime  @default(now())
  
  autor           tHEmpleado @relation("FeedbackAutor", fields: [deParteId], references: [id])
  empleado        tHEmpleado @relation("FeedbackDestino", fields: [empleadoId], references: [id])
}

model tHCapacitacion {
  id              String    @id @default(uuid())
  nombre          String
  descripcion     String?
  categoria       String    // TECNICA, HABILIDADES_BLANDAS, SST, INDUCCION
  modalidad       String    // VIRTUAL, PRESENCIAL, MIXTA
  proveedor       String?
  instructor      String?
  fechaInicio     DateTime
  fechaFin        DateTime?
  duracionHoras   Int
  cupoMaximo      Int?
  estado          String    // PROGRAMADA, EN_CURSO, FINALIZADA, CANCELADA
  ubicacion       String?
  linkAcceso      String?
  createdAt       DateTime  @default(now())
  
  asistentes      tHAsistenteCapacitacion[]
}

model tHAsistenteCapacitacion {
  id              String    @id @default(uuid())
  capacitacionId  String
  empleadoId      String
  estado          String    // INSCRITO, ASISTIO, NO_ASISTIO, APROBADO, REPROBADO
  calificacion    Decimal?  @db.Decimal(4, 2)
  certificadoUrl  String?
  fechaInscripcion DateTime @default(now())
  
  capacitacion    tHCapacitacion @relation(fields: [capacitacionId], references: [id])
  empleado        tHEmpleado     @relation(fields: [empleadoId], references: [id])
}

model tHBeneficio {
  id              String    @id @default(uuid())
  nombre          String
  descripcion     String?
  tipo            String    // SALUD, EDUCACION, RECREACION, FINANCIERO
  valorMensual    Decimal?  @db.Decimal(12, 2)
  requisitos      String?
  activo          Boolean   @default(true)
  createdAt       DateTime  @default(now())
  
  asignaciones    tHBeneficioEmpleado[]
}

model tHBeneficioEmpleado {
  id              String    @id @default(uuid())
  beneficioId     String
  empleadoId      String
  fechaInicio     DateTime  @default(now())
  fechaFin        DateTime?
  estado          String    // ACTIVO, INACTIVO
  
  beneficio       tHBeneficio @relation(fields: [beneficioId], references: [id])
  empleado        tHEmpleado  @relation(fields: [empleadoId], references: [id])
}

model tHEncuesta {
  id              String    @id @default(uuid())
  titulo          String
  descripcion     String?
  tipo            String    // CLIMA, SATISFACCION, SALIDA
  fechaInicio     DateTime
  fechaFin        DateTime
  estado          String    // BORRADOR, ACTIVA, CERRADA
  esAnonima       Boolean   @default(true)
  preguntas       Json      // Array de preguntas
  createdAt       DateTime  @default(now())
  
  respuestas      tHRespuestaEncuesta[]
}

model tHRespuestaEncuesta {
  id              String    @id @default(uuid())
  encuestaId      String
  empleadoId      String?   // Opcional si es anónima
  respuestas      Json      // Respuestas a las preguntas
  fechaRespuesta  DateTime  @default(now())
  
  encuesta        tHEncuesta @relation(fields: [encuestaId], references: [id])
}

model tHEvento {
  id              String    @id @default(uuid())
  titulo          String
  descripcion     String?
  tipo            String    // CELEBRACION, INTEGRACION, SALUD
  fecha           DateTime
  horaInicio      String?
  horaFin         String?
  ubicacion       String?
  cupoMaximo      Int?
  esObligatorio   Boolean   @default(false)
  estado          String    // PROGRAMADO, REALIZADO, CANCELADO
  createdAt       DateTime  @default(now())
  
  asistentes      tHAsistenteEvento[]
}

model tHAsistenteEvento {
  id              String    @id @default(uuid())
  eventoId        String
  empleadoId      String
  estado          String    // CONFIRMADO, ASISTIO, NO_ASISTIO
  fechaRegistro   DateTime  @default(now())
  
  evento          tHEvento   @relation(fields: [eventoId], references: [id])
  empleado        tHEmpleado @relation(fields: [empleadoId], references: [id])
}

model tHReconocimiento {
  id              String    @id @default(uuid())
  empleadoId      String
  otorgadoPorId   String    @db.Uuid
  tipo            String    // EMPLEADO_MES, ANTIGUEDAD, LOGRO
  titulo          String
  descripcion     String?
  fecha           DateTime
  valorAsociado   String?   // Valor corporativo relacionado
  esPublico       Boolean   @default(true)
  createdAt       DateTime  @default(now())
  
  empleado        tHEmpleado @relation(fields: [empleadoId], references: [id])
  otorgador       Usuario    @relation(fields: [otorgadoPorId], references: [id])
}

model tHConversacionIA {
  id              String    @id @default(uuid())
  usuarioId       String    @db.Uuid
  tipo            String    // CHAT, SCREENING, ENTREVISTA, DESEMPENO
  contexto        Json?     // Datos usados (vacanteId, empleadoId, etc)
  mensajes        Json      // Historial de mensajes
  tokensUsados    Int       @default(0)
  createdAt       DateTime  @default(now())
  
  usuario         Usuario   @relation(fields: [usuarioId], references: [id])
}
